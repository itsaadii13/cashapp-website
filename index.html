<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cash App - SetupIntent Simulator</title>

  <!-- Bootstrap & FontAwesome -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <style>
    :root{
      --cash-green: #00c853;
      --cash-dark: #0b3d2e;
      --accent: #00bfa5;
      --bg: #f4fbf9;
      --card: #ffffff;
      --muted: #6b7280;
      --mono: "Courier New", monospace;
    }

    /* Dark mode variables (toggled via .dark-mode on body) */
    body.dark-mode{
      --bg: #0f1720;
      --card: #0b1220;
      --muted: #9aa4ad;
    }

    html,body{height:100%}
    body{
      background: linear-gradient(135deg,var(--bg) 0%, #e9f9f3 100%);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      padding: 24px;
      color: #0b1220;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .header {
      border-radius: 14px;
      background: linear-gradient(135deg,var(--cash-dark), var(--cash-green));
      color: white;
      padding: 26px;
      box-shadow: 0 12px 30px rgba(11,18,32,0.12);
      text-align:center;
      margin-bottom: 22px;
    }

    .card {
      background: var(--card);
      border: none;
      border-radius: 14px;
      box-shadow: 0 8px 20px rgba(11,18,32,0.06);
      overflow: hidden;
    }

    .setup-card {
      padding: 20px;
      margin-bottom: 20px;
      position: relative;
    }

    .setup-card::before{
      content:'';
      position:absolute;
      left:0;right:0;top:0;height:4px;
      background: linear-gradient(90deg,var(--cash-green), var(--accent));
    }

    .qr-container{
      background: linear-gradient(135deg,#e6fff5 0%, #d3fff0 100%);
      border-radius: 12px;
      padding: 18px;
      text-align:center;
      border: 2px dashed rgba(0,200,80,0.12);
    }

    .qr-code{
      display:inline-block;
      background: #fff;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 6px 18px rgba(11,18,32,0.06);
    }

    .step-indicator{
      display:flex;
      gap:12px;
      align-items:center;
      margin: 22px 0;
      position: relative;
    }

    .step-indicator::before{
      content:'';
      position:absolute;
      left:20px;right:20px;top:22px;height:2px;background:#e6e6e6;z-index:1;
      border-radius:2px;
    }

    .step {
      z-index:2;
      flex:1;
      text-align:center;
    }

    .step-circle{
      width:44px;height:44px;border-radius:50%;
      background:#e9ecef;display:inline-flex;align-items:center;justify-content:center;
      font-weight:700;color: #2b2b2b;margin-bottom:8px;
    }

    .step-label{font-size:13px;color:var(--muted)}

    .step.active .step-circle{background:var(--cash-green);color:white; box-shadow:0 6px 18px rgba(0,200,83,0.18)}
    .step.completed .step-circle{background:#00b300;color:white}
    .step.active .step-label{color:var(--cash-dark);font-weight:700}
    .step.completed .step-label{color:#07652f;font-weight:700}

    .json-display {
      background: #0f1720;
      color: #f8f8f2;
      border-radius: 8px;
      padding: 12px;
      font-family: var(--mono);
      font-size: 13px;
      overflow-x:auto;
      line-height:1.45;
    }

    body.dark-mode .json-display { background: #071018; color:#e6f7f1; }

    .json-key{ color:#f78fb3; }
    .json-string{ color:#b7f5d4; }
    .json-number{ color:#b6d9ff; }
    .json-boolean{ color:#ffcb6b; }
    .json-null{ color:#9aa4ad; }

    .action-buttons{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-top:14px}
    .action-button{min-width:190px;flex:1}

    .footer-text{ text-align:center;color:var(--muted);margin-top:18px;font-size:13px }

    .dark-toggle {
      position: absolute;
      top: 18px;
      right: 18px;
    }

    @media(max-width:768px){
      .step-indicator{flex-direction:column;gap:14px}
      .step-indicator::before{display:none}
      .action-buttons{flex-direction:column}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 class="h4 mb-1"><i class="fab fa-cashapp me-2"></i>Cash App Setup — Simulator</h1>
      <p class="mb-0 small">Simulate a SetupIntent QR + redirect flow (interactive developer sandbox).</p>
    </div>

    <div class="row justify-content-center">
      <div class="col-lg-8">

        <div class="card setup-card position-relative">
          <button class="btn btn-sm btn-outline-light dark-toggle" id="darkToggle" title="Toggle dark mode">
            <i class="fas fa-moon me-1"></i> Dark
          </button>

          <h5 class="mb-3"><i class="fas fa-lock me-2"></i>Complete Payment Method Setup</h5>

          <div class="step-indicator" id="steps">
            <div class="step" data-step="1">
              <div class="step-circle">1</div>
              <div class="step-label">Setup</div>
            </div>
            <div class="step" data-step="2">
              <div class="step-circle">2</div>
              <div class="step-label">Authenticate</div>
            </div>
            <div class="step" data-step="3">
              <div class="step-circle">3</div>
              <div class="step-label">Complete</div>
            </div>
          </div>

          <div class="alert alert-info d-flex align-items-start">
            <div class="me-2"><i class="fas fa-info-circle"></i></div>
            <div>
              This sandbox simulates the SetupIntent lifecycle. When the flow finishes, a simulated webhook will appear and the SetupIntent status will update to <code>succeeded</code>.
              Use the buttons below to simulate user actions.
            </div>
          </div>

          <div class="qr-container">
            <h6 class="mb-2">Scan QR Code with Cash App</h6>
            <div class="qr-code mb-2">
              <img src="https://qr.stripe.com/test_YWNjdF8xUmE2TW9RazFzc0haWDFxLF9UQk56WVdabTdMeDJ1SlJlb1NGOExtd254V2hzYVhq0100ja69a8Us.png" alt="QR Code" style="max-width:210px;display:block">
            </div>
            <div class="small text-muted mb-1">Or open using mobile auth URL</div>
            <div class="action-buttons">
              <button class="btn btn-success action-button" id="openAppBtn">
                <i class="fab fa-apple me-2"></i>Open in Cash App
              </button>
              <button class="btn btn-outline-success action-button" id="mobileAuthBtn">
                <i class="fas fa-mobile-alt me-2"></i>Use Mobile Auth
              </button>
            </div>
          </div>

          <div class="mt-3">
            <div class="row g-2">
              <div class="col-md-6">
                <small class="text-muted">Setup Intent ID</small>
                <div> <strong id="siId">seti_1SF12eQk1ssHZX1qvC02MY6Z</strong> </div>
              </div>
              <div class="col-md-6">
                <small class="text-muted">Status</small>
                <div> <span id="statusBadge" class="badge bg-warning text-dark">requires_action</span> </div>
              </div>
              <div class="col-md-6 mt-2">
                <small class="text-muted">Payment Method</small>
                <div>pm_1SF1DxQk1ssHZX1qTfIaNQx9</div>
              </div>
              <div class="col-md-6 mt-2">
                <small class="text-muted">Usage</small>
                <div>Off Session</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Webhook & controls -->
        <div class="card setup-card">
          <h6><i class="fas fa-bolt me-2"></i>Simulation Controls & Webhook</h6>

          <div class="d-flex gap-2 flex-wrap mt-2 mb-2">
            <button class="btn btn-outline-secondary btn-sm" id="simulateAuthBtn"><i class="fas fa-play me-1"></i>Simulate User Auth</button>
            <button class="btn btn-outline-primary btn-sm" id="simulateProcessingBtn"><i class="fas fa-spinner me-1"></i>Simulate Processing</button>
            <button class="btn btn-success btn-sm" id="simulateSuccessBtn"><i class="fas fa-check me-1"></i>Simulate Success</button>
            <button class="btn btn-danger btn-sm" id="simulateFailBtn"><i class="fas fa-xmark me-1"></i>Simulate Fail</button>
            <button class="btn btn-outline-dark btn-sm" id="copySetupBtn"><i class="fas fa-copy me-1"></i>Copy SetupIntent JSON</button>
          </div>

          <div id="webhookArea"></div>
        </div>

        <!-- SetupIntent JSON -->
        <div class="card setup-card">
          <h6><i class="fas fa-code me-2"></i>SetupIntent object</h6>
          <div class="d-flex justify-content-end mb-2">
            <button class="btn btn-sm btn-outline-secondary me-2" id="refreshJsonBtn"><i class="fas fa-sync-alt"></i> Refresh</button>
            <button class="btn btn-sm btn-outline-secondary" id="copyPmBtn"><i class="fas fa-copy me-1"></i>Copy PM Options JSON</button>
          </div>

          <div class="json-display" id="setupIntentJson"></div>
        </div>

        <!-- Payment Method Options JSON -->
        <div class="card setup-card">
          <h6><i class="fas fa-list-ul me-2"></i>Payment Method Options object</h6>
          <div class="json-display" id="paymentMethodOptionsJson"></div>
        </div>

        <div class="footer-text">
          <p>If you unexpectedly reached this page while checking out on a website, you won't be charged. Contact support with the URL.</p>
          <small class="text-muted">© 2024 Cash App Test Environment — Simulator</small>
        </div>

      </div>
    </div>
  </div>

  <!-- Bootstrap Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Initial JS data (mirrors what you provided, with epoch times relative to now)
    const setupIntentData = {
      id: "seti_1SF12eQk1ssHZX1qvC02MY6Z",
      object: "setup_intent",
      client_secret: "seti_1SF12eQk1ssHZX1qvC02MY6Z_secret_TBNoOv39LSJxCZB6pDQtYKlCDzLMIBa",
      created: Math.floor(Date.now() / 1000),
      livemode: false,
      next_action: {
        cashapp_handle_redirect_or_display_qr_code: {
          hosted_instructions_url: "https://payments.stripe.com/qr/instructions/CDQaFwoVYWNjdF8xUmE2TW9RazFzc0haWDFx",
          mobile_auth_url: "https://pm-redirects.stripe.com/authorize/acct_1Ra6MoQk1ssHZX1q/sa_nonce_TBNzG0dKy",
          qr_code: {
            expires_at: Math.floor(Date.now() / 1000) + 900,
            image_url_png: "https://qr.stripe.com/test_YWNjdF8xUmE2TW9RazFzc0haWDFx.png",
            image_url_svg: "https://qr.stripe.com/test_YWNjdF8xUmE2TW9RazFzc0haWDFx.svg"
          }
        },
        type: "cashapp_handle_redirect_or_display_qr_code"
      },
      payment_method: "pm_1SF1DxQk1ssHZX1qTfIaNQx9",
      payment_method_types: ["card","cashapp","us_bank_account"],
      status: "requires_action",
      usage: "off_session"
    };

    const paymentMethodOptionsData = {
      card: { mandate_options: null, network: null, request_three_d_secure: "automatic" },
      us_bank_account: {
        financial_connections: { permissions: ["payment_method"], prefetch: [] },
        mandate_options: {},
        verification_method: "automatic"
      }
    };

    // Utility: pretty-print JSON & syntax highlight
    function formatJson(obj){
      return JSON.stringify(obj, null, 2);
    }

    function highlightJson(json){
      // Escape HTML
      json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      // Strings
      json = json.replace(/("(\\.|[^"\\])*")(:)?/g, function(match, p1, _, p3){
        if(p3) return '<span class="json-string">'+p1+'</span>' + '<span class="json-key">'+p3+'</span>';
        return '<span class="json-string">'+p1+'</span>';
      });
      // Booleans & null
      json = json.replace(/\b(true|false)\b/g, '<span class="json-boolean">$1</span>');
      json = json.replace(/\b(null)\b/g, '<span class="json-null">$1</span>');
      // Numbers
      json = json.replace(/\b(\d+)\b/g, '<span class="json-number">$1</span>');
      // Braces & punctuation coloring (keys handled above)
      json = json.replace(/(\{|\}|\[|\]|,|:)/g, '<span class="json-key">$1</span>');
      return json;
    }

    // Render initial JSON displays
    function renderJsonDisplays(){
      document.getElementById('setupIntentJson').innerHTML = highlightJson(formatJson(setupIntentData));
      document.getElementById('paymentMethodOptionsJson').innerHTML = highlightJson(formatJson(paymentMethodOptionsData));
      updateStatusBadge();
    }

    // Step UI helpers
    function setStepState(stepIndex){
      const steps = document.querySelectorAll('.step');
      steps.forEach((el, i) => {
        el.classList.remove('active','completed');
        if(i < stepIndex-1) el.classList.add('completed');
        if(i === stepIndex-1) el.classList.add('active');
      });
    }

    // Update status badge UI
    function updateStatusBadge(){
      const badge = document.getElementById('statusBadge');
      const s = setupIntentData.status;
      badge.className = 'badge';
      if(s === 'requires_action') badge.classList.add('bg-warning','text-dark');
      else if(s === 'processing') badge.classList.add('bg-info','text-white');
      else if(s === 'succeeded') badge.classList.add('bg-success','text-white');
      else if(s === 'failed') badge.classList.add('bg-danger','text-white');
      badge.textContent = s;
    }

    // Simulated webhook panel
    function addWebhookEvent(eventType, payload){
      const area = document.getElementById('webhookArea');
      const el = document.createElement('div');
      el.className = 'alert mt-2';
      if(eventType === 'setup_intent.succeeded') el.classList.add('alert-success');
      else if(eventType === 'setup_intent.processing') el.classList.add('alert-info');
      else if(eventType === 'setup_intent.requires_action') el.classList.add('alert-warning');
      else el.classList.add('alert-secondary');

      el.innerHTML = `<strong>Simulated webhook:</strong> <code>${eventType}</code>
        <div class="mt-2"><small class="text-muted">Payload (excerpt):</small>
        <pre style="white-space:pre-wrap;margin:6px 0;">${JSON.stringify(payload, null, 2)}</pre></div>`;
      area.prepend(el);
    }

    // Copy helpers
    async function copyText(text){
      try {
        await navigator.clipboard.writeText(text);
        showToast('Copied to clipboard');
      } catch(e){
        alert('Could not copy: ' + e.message);
      }
    }

    // Tiny toast
    function showToast(msg){
      const t = document.createElement('div');
      t.className = 'position-fixed px-3 py-2 rounded shadow';
      t.style.right = '18px';
      t.style.bottom = '18px';
      t.style.background = 'rgba(11,18,32,0.9)';
      t.style.color = 'white';
      t.style.zIndex = 1200;
      t.innerText = msg;
      document.body.appendChild(t);
      setTimeout(()=> t.style.opacity = '0.1', 1500);
      setTimeout(()=> t.remove(), 2100);
    }

    // Simulated flow behaviors
    document.addEventListener('DOMContentLoaded', () => {
      renderJsonDisplays();
      setStepState(1);

      // Button actions
      document.getElementById('openAppBtn').addEventListener('click', () => {
        // In real life redirect; here simulate auth starting
        showToast('Simulating opening Cash App (mock)');
        simulateUserAuth();
      });

      document.getElementById('mobileAuthBtn').addEventListener('click', () => {
        showToast('Simulating mobile auth URL (mock)');
        simulateUserAuth();
      });

      document.getElementById('simulateAuthBtn').addEventListener('click', simulateUserAuth);
      document.getElementById('simulateProcessingBtn').addEventListener('click', simulateProcessing);
      document.getElementById('simulateSuccessBtn').addEventListener('click', simulateSuccess);
      document.getElementById('simulateFailBtn').addEventListener('click', simulateFail);

      document.getElementById('copySetupBtn').addEventListener('click', () => {
        copyText(formatJson(setupIntentData));
      });
      document.getElementById('copyPmBtn').addEventListener('click', () => {
        copyText(formatJson(paymentMethodOptionsData));
      });
      document.getElementById('refreshJsonBtn').addEventListener('click', renderJsonDisplays);

      // Copy individual JSON areas by clicking them
      document.getElementById('setupIntentJson').addEventListener('dblclick', () => copyText(formatJson(setupIntentData)));
      document.getElementById('paymentMethodOptionsJson').addEventListener('dblclick', () => copyText(formatJson(paymentMethodOptionsData)));

      // Dark mode toggle
      const darkBtn = document.getElementById('darkToggle');
      darkBtn.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        darkBtn.innerHTML = document.body.classList.contains('dark-mode') ? '<i class="fas fa-sun me-1"></i> Light' : '<i class="fas fa-moon me-1"></i> Dark';
      });
    });

    // Flow simulation helpers
    function simulateUserAuth(){
      // Move to Authenticate step
      setStepState(2);
      setupIntentData.status = 'processing';
      renderJsonDisplays();
      addWebhookEvent('setup_intent.requires_action', { id: setupIntentData.id, status: 'processing' });

      // After a short delay, simulate server processing
      setTimeout(() => {
        simulateProcessing();
      }, 1500);
    }

    function simulateProcessing(){
      setStepState(2);
      setupIntentData.status = 'processing';
      renderJsonDisplays();
      addWebhookEvent('setup_intent.processing', { id: setupIntentData.id, status: 'processing' });

      // If left alone, progress to success after a short timeout to mimic webhook asynchronous behavior
      // (This is just simulation; in production you'd rely on actual webhooks.)
      clearTimeout(window.__autoSuccessTimer);
      window.__autoSuccessTimer = setTimeout(() => {
        simulateSuccess();
      }, 2400);
    }

    function simulateSuccess(){
      clearTimeout(window.__autoSuccessTimer);
      setupIntentData.status = 'succeeded';
      setStepState(3);
      renderJsonDisplays();
      addWebhookEvent('setup_intent.succeeded', { id: setupIntentData.id, status: 'succeeded', payment_method: setupIntentData.payment_method });

      // show final visual cue
      showToast('SetupIntent succeeded — payment method available for future use');
    }

    function simulateFail(){
      clearTimeout(window.__autoSuccessTimer);
      setupIntentData.status = 'failed';
      setStepState(1);
      renderJsonDisplays();
      addWebhookEvent('setup_intent.failed', { id: setupIntentData.id, status: 'failed', last_setup_error: { message: 'Simulated failure' } });
      showToast('Simulated failure — check webhook for details');
    }

    // Render initial on load
    renderJsonDisplays();
  </script>
</body>
</html>